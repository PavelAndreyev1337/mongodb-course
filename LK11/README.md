# Тема 11: Міграції та резервне копіювання

Важливо забезпечити безперервність роботи додатків, захист даних та їх міграцію між середовищами та версіями. Для цього застосовують міграції даних і резервне копіювання.

## Резервне копіювання в MongoDB
Резервне копіювання (бекап) - це створення копії даних у певний момент часу для їх відновлення у разі втрати або пошкодження.


 **mongodump / mongorestore** - основні інструменти для створення і відновлення резервних копій MongoDB.


Приклад створення резервної копії бази даних за допомогою mongodump:

```mongodump --db newdb --out /path/to/backup/directory```

Ця команда створює дамп бази newdb у вказаному каталозі.

Приклад відновлення:

```mongorestore --db newdb --drop /path/to/backup/directory/newdb```

Опція **--drop** видаляє поточну базу перед відновленням.

Планове резервне копіювання виконується, наприклад через cron на Linux. Для цього редагуємо cron для автоматизації:
```sudo crontab -e```

Додаємо рядок для щоденного видалення старих бекапів (старше 7 днів):

```
1 3 * * * find /var/backups/mongobackups/ -mtime +7 -exec rm -rf {} \;
```

* 1 3 * * * - це розклад у cron, що означає запуск команди щодня о 03:01 за системним часом:
  * перше поле - хвилина (0-59): 1 означає 1-ша хвилина години;

  * друге поле - година (0-23): 3 означає 3-тя година ранку;

  * третє поле - день місяця (1-31): * означає будь-який день місяця;

  * четверте поле - місяць (1-12): * означає будь-який місяць;

  * п’яте поле - день тижня (0-6): * означає будь-який день тижня.

  * `find /var/backups/mongobackups/` — команда find шукає файли і папки в каталозі /var/backups/mongobackups/ рекурсивно.

  * -mtime +7 — опція -mtime означає час останньої модифікації файлу. +7 означає "файли, змінені більше ніж 7 днів тому" (тобто старше 7 діб).

  * -exec rm -rf {} \; - для кожного файла, знайденого командою find, виконується команда rm -rf, яка рекурсивно і без підтвердження видаляє цей файл чи папку замість {} (поточний файл з результатів find).

Основні аспекти резервного копіювання:
* команди **mongodump** і **mongorestore** працюють з двійковими дампами, зберігають індекси і типи даних;
* резервне копіювання можна робити однієї бази чи окремих колекцій.
* важливо забезпечувати консистентність даних — у дуже навантажених системах можлива розбіжність при створенні бекапа, тому використовують механізми реплікації або знімають дампи з репліка-сетів.

## Міграції в MongoDB
Міграції - це процес зміни схеми бази даних, оновлення структури документів або перенесення даних між середовищами.

Різновиди міграцій:
* міграція версій бази (оновлення версій MongoDB) — зазвичай вимагає резервного копіювання та відновлення/оновлення;

* міграція структури даних - додавання полів, конвертація форматів, зміна типів даних;

* міграція між серверами чи середовищами — перенос даних через резервні копії або реплікацію.

Приклади зміни структури (міграція схеми через скрипти):
* додавання нового поля у всі документи колекції:

```javascript
db.users.updateMany(
  {},  // Порожній фільтр означає всі документи
  { $set: { isActive: true } } // Додаємо поле isActive зі значенням true
);
```

оновлення типу поля (наприклад, зміна формату дати). Припустимо, у колекції orders поле orderDate зберігається у вигляді рядка, а треба перетворити його у формат дати:

```javascript
db.orders.find().forEach(function(order) {
  var newDate = new Date(order.orderDate); // Перетворюємо рядок в дату
  db.orders.updateOne(
    { _id: order._id },
    { $set: { orderDate: newDate } }
  );
});
```
* конвертація масиву у вкладений документ. Припустимо, у колекції test є поле items, що зараз є масивом рядків:

```json
{ "_id": 1, "items": ["apple", "banana", "pear"] }
```
Треба його перетворити в масив об’єктів із структурою {name, qty}:

```json
{ "_id": 1, "items": [ { "name": "apple", "qty": 1 }, { "name": "banana", "qty": 1 },
```

```javascript
db.test.find().forEach(function(doc) {
  if(Array.isArray(doc.items)) {
    var newItems = doc.items.map(function(item) {
      return { name: item, qty: 1 };
    });
    db.test.updateOne(
      { _id: doc._id },
      { $set: { items: newItems } }
    );
  }
});
```
Цей скрипт ітерує всі документи, перевіряє, що items це масив, і замінює його на потрібний формат.

