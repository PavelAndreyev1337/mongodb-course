# Лекція 3: CRUD-операції
Для прискорення запитів до бази даних у MongoDB застосовують індекси. Вони дозволяють системі швидко знаходити потрібні документи без повного сканування колекції, що особливо важливо при великому обсязі даних. У цій лекції ми детально розглянемо концепцію індексів у MongoDB, розглянемо, як вони працюють, які бувають типи, як їх створити та ефективно використовувати у повсякденній роботі.

## Що таке індекси та навіщо вони потрібні?
Якщо уявити базу даних як величезну книгу, у якій кожен документ — це сторінка з інформацією, то індекси — це своєрідний алфавітний покажчик, що допомагає швидко знайти сторінки, які містять потрібне слово чи ідею. Без індексів система змушена відкривати кожну сторінку та шукати вручну, що займатиме багато часу.

У MongoDB дані зберігаються у колекціях (аналог таблиць у реляційних базах), де кожен документ може мати унікальну структуру. При цьому часто потрібно швидко знайти документи за певним полем або набором полів. Індекси вирішують цю проблему, створюючи додаткові структури, які вказують на позиції документів за певними ключами.

**Основні переваги індексів:**
* швидкий пошук документів за індексованими полями;

* прискорення виконання складних запитів з фільтрацією і сортуванням;

* виконання унікальних обмежень (унікальні індекси);

* автоматичне керування життєвим циклом документів (TTL-індекси).

**Недоліки індексів:**
* використання додаткового дискового простору;
* збільшення часу операцій вставки, оновлення і видалення, бо індекс треба оновити також.
* необхідність розумного підходу до вибору індексів, аби не погіршити продуктивність.

MongoDB, за замовчуванням, використовує структуру даних B-дерево (B-tree) для зберігання індексів. Це збалансоване дерево, яке дозволяє швидко виконувати операції пошуку, вставки та видалення.

## Як працює B-tree?
Вузли дерева: містять ключі (значення індексованих полів) та вказівники на інші вузли або дані Балансування: дерево підтримується збалансованим, тому всі листки знаходяться на одному рівні
Швидкість: пошук виконується за логарифмічний час, що значно швидше, ніж послідовний перегляд. Обхід: при зверненні до індексу MongoDB шукає ключ у корені і переходить до гілки, де може бути ключ, доки не знайде відповідне посилання на документ. Вузли містять посилання на документи в базі.
Таким чином, MongoDB швидко знаходить документи без необхідності повного перегляду усієї колекції.

[Більш детально про B-tree.](https://uk.wikipedia.org/wiki/%D0%91-%D0%B4%D0%B5%D1%80%D0%B5%D0%B2%D0%BE)

## Основні типи індексів у MongoDB

**1. Однопольові індекси**

Створюються для одного поля. Найпростіший тип індексу, який оптимізує пошук та сортування за цим полем.

```javascript
db.users.createIndex({ "username": 1 })
// Поле — username
```

Напрямок індексації: 1 — за зростанням (за алфавітом або числово)

Якщо запити часто шукають користувачів за іменем, цей індекс прискорить запит.

**2. Композитні індекси** (індекси на кілька полів) - це індекси, які створюються одночасно на кількох полях.

```javascript
db.users.createIndex({ "lastName": 1, "firstName": 1 })
```
Використовуються для запитів, які фільтрують або сортують за кількома полями одночасно.

Порядок полів важливий: індекс оптимізує запити, які спочатку фільтрують за першим полем, потім за другим.

**3. Унікальні індекси**

Гарантують, що у значеннях індексованого поля немає повторень.

```javascript
db.users.createIndex({ "email": 1 }, { unique: true })
```

Використовується для унікальних ідентифікаторів, логінів, електронної пошти. Запобігає додаванню документів з однаковими значеннями.

**4. Часткові індекси (Partial Index)**

Індекс створюється лише для документів, які відповідають певній умові.

```javascript
db.users.createIndex(
  { "status": 1 },
  { partialFilterExpression: { "status": "active" } }
)
```

При запитах, які фільтрують тільки активних користувачів, система використовуватиме цей індекс.

Зменшує розмір індексу, якщо великі частини колекції не потребують індексації.

**5. TTL-індекси (Time To Live)**

Цей індекс автоматично видаляє документи після визначеного часу.

```javascript
db.sessions.createIndex(
  { "createdAt": 1 },
  { expireAfterSeconds: 3600 }  // видаляє документи через 1 годину
)
```

Застосовується для сесій, кеша, логів, які мають обмежений термін життя. Поле повинне бути датою.


## Практика роботи з індексами
### Створення індексу
Щоб створити індекс у MongoDB, використовується метод createIndex. Нижче синтаксис створення індексу за одним полем:

```javascript
db.<collection>.createIndex({ <field>: <direction> })
```

`<collection>` — назва колекції

`<field>` — поле, за яким будується індекс

`<direction>` — напрямок індексації: 1 — по зростанню, -1 — по спаданню

Наприклад:

```javascript
db.products.createIndex({ "price": -1 })
```

Це створить індекс за спаданням ціни, корисний для запитів з сортуванням від дорогих до дешевих товарів.

### Перегляд індексів
Для перегляду індексів у колекції використовується:

```javascript
db.<collection>.getIndexes()
```

Цей метод повертає список усіх індексів з деталями: поля, унікальність, ім'я індексу.

### Видалення індексу
Для видалення:

```javascript
db.<collection>.dropIndex("<indexName>")
```

Ім'я індексу можна побачити у результаті getIndexes.

## Пояснення на прикладах
Приклад 1: Проста колекція користувачів
Документи:

```json
{ "_id": 1, "name": "Андрій", "age": 25, "email": "andriy@example.com" }
{ "_id": 2, "name": "Олена", "age": 30, "email": "olena@example.com" }
{ "_id": 3, "name": "Іван", "age": 20, "email": "ivan@example.com" }
```

Індекс за email

```javascript
db.users.createIndex({ "email": 1 }, { unique: true })
```

Швидкий пошук за email, заборона повторень.

Запит з використанням індексу:

```javascript
db.users.find({ "email": "ivan@example.com" })
```

MongoDB шукає адресу документу в B-дереві індексу і швидко повертає результат.

Приклад 2: Колекція товарів
Документи:

```json
{ "_id": 1, "name": "Телефон", "price": 700, "category": "Електроніка", "inStock": true }
{ "_id": 2, "name": "Ноутбук", "price": 1500, "category": "Електроніка", "inStock": false }
{ "_id": 3, "name": "Книга", "price": 15, "category": "Культура", "inStock": true }
```

Композитний індекс за полями category і price:

```javascript
db.products.createIndex({ "category": 1, "price": -1 })
```

Запит, який використає індекс:

```javascript
db.products.find({ category: "Електроніка" }).sort({ price: -1 })
```
MongoDB швидко знайде документи "Електроніка" і відсортує їх за ціною за спаданням.

### Як працює пошук із індексами
Пояснення на рівні пошуку
Коли ви робите запит у MongoDB, система аналізує, чи існує індекс, який можна використати для конкретного запиту. Якщо так — MongoDB звертається до B-дерева індексу, знаходить ключ з потрібним значенням і повертає адресу документа на диск.

Якщо індексів немає, MongoDB виконує collection scan — повне послідовне сканування усіх документів у колекції.

### Використання індексів у сортуванні
Індекси також оптимізують сортування. Якщо поле за яким сортують є частиною індексу, MongoDB може використовувати B-дерево з вже відсортованими ключами, зекономивши час. Наприклад, індекс за полями { category: 1, price: -1 } може ефективно обробити запити з фільтром по категорії та сортуванням за ціною.

### Використання індексів для часткових полів і масивів
MongoDB індексує навіть поля, що містять масиви. При індексації масиву всі значення масиву будуть проіндексовані як окремі ключі. Це дозволяє швидко знаходити документи, які містять у полі потрібне значення з масиву.

Управління індексами, найкращі практики: 
* індексувати поля, які часто використовуються у фільтрації (часто у **find()** або **findOne()**);

* індексувати поля, які часто використовуються для сортування (**sort()**);

* не індексувати поля, які рідко використовуються і часто змінюються;

* обирайте правильний тип індексу;
* для полів з унікальними значеннями — унікальний індекс.
* для запитів, що використовують кілька полів одночасно — композитний індекс.
* для документів з обмеженим життєвим циклом — TTL-індекс.

Обережно зі створенням індексів на великих колекціях,
створення індексу може бути ресурсозатратним.

Використовуйте фонове створення індексів, щоб не блокувати роботу бази:

```javascript
db.collection.createIndex({ field: 1 }, { background: true })
```

Перевіряйте використання індексів за допомогою методу **explain()** можна побачити, який індекс використовується у запиті і його ефективність:

```javascript
db.collection.find({ field: "value" }).explain("executionStats")
```

Це допоможе оптимізувати ваші індекси і покращити продуктивність.

### Спеціальні типи індексів
### Геопросторові індекси
Для даних із координатами (широта, довгота). MongoDB підтримує два типи:

* 2d — для плоских координат

* 2dsphere — для координат на сфері (наприклад, Земля)

Приклад створення:

```javascript
db.places.createIndex({ location: "2dsphere" })
```

### Текстові індекси
Для пошуку по тексту у полях документів. MongoDB створює індекс, який підтримує повнотекстовий пошук.

```javascript
db.articles.createIndex({ content: "text" })
```

Пошук:

```javascript
db.articles.find({ $text: { $search: "MongoDB" } })
```

### Вплив індексів на операції запису

Індекси створюють додаткові витрати під час вставки, оновлення і видалення даних. MongoDB має оновлювати всі індекси, релевантні до змінених полів. Чим більша кількість індексів і чим складніша їх структура, тим довше тривають операції запису. Тому важливо балансувати кількість індексів, щоб прискорити читання, але не дуже загальмувати запис.

Проводьте регулярний перегляд індексів і видаляйте непотрібні.

### Висновок
Індекси — це один із найважливіших механізмів для оптимізації роботи з даними в MongoDB. Вміння правильно створювати та керувати індексами суттєво впливає на продуктивність застосунку.

За замовчуванням структура індексу — B-tree, що забезпечує швидкий пошук з логарифмічною складністю. Існують різні типи індексів, адаптовані для різних сценаріїв: прості, композитні, унікальні, TTL, часткові, геопросторові і текстові.

Важливо враховувати компроміси між пришвидшенням читання і уповільненням запису даних, а також контролювати використання індексів, щоб підтримувати високу швидкодію системи.
