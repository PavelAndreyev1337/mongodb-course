# Лекція 7: Повнотекстний пошук
## Вступ
Повнотекстовий пошук у MongoDB — це механізм, що дозволяє ефективно шукати текстові дані в документах бази, орієнтований на пошук слів і фраз по цілих колекціях. Це унікальна можливість для обробки великих масивів текстової інформації, де необхідно знайти не просто співпадіння за значеннями, а збіги за важливими словами або ключовими поняттями у тексті.

Для цього створюємо текстовий індекс, робимо запит, а система сама прибирає стоп-слова, виконує токенізацію, стемінг та призначає числову характеристику, яка визначає релевантність результату. Для стемінгу використовується Стеммер Портера.
Повнотекстовий пошук у MongoDB підтримує різні мови для кращої морфологічної обробки тексту, що включає правильне розпізнавання коренів слів, стоп-слів тощо. Серед підтримуваних мов у MongoDB, наприклад, є: англійська, французька, німецька, італійська, іспанська, шведська, турецька, голландська, норвезька, фінська, угорська, румунська, датська, португальська та деякі інші.

MongoDB використовує мову індексації, яку можна вказати під час створення текстового індексу через параметр **default_language** (за замовчуванням — англійська). Якщо потрібно, можна змінити її для кращої релевантності пошукових результатів на мову, що відповідає тексту в документах.

Варто зазначити, що підтримка деяких мов може бути базовою і не включати повну морфологію або синоніми, а також частково підтримує стоп-слова (наприклад, "і", "та", "але" для української можуть не підтримуватися стандартно).
Українська мова у повнотекстовому пошуку MongoDB не підтримується офіційно та повноцінно як деякі інші мови (наприклад, англійська). 

Основна структура, що використовується — це інвертований індекс (inverted index). Цей індекс містить словник усіх унікальних токенів (слів) з колекції, де для кожного токена зберігається список документів, у яких це слово зустрічається, а також позиції слова у документах. За допомогою інвертованого індексу пошукова система швидко знаходить документи, що містять певне слово або набір слів.

У контексті повнотекстового пошуку B-дерево зазвичай використовується для організації індексів (включаючи інвертований індекс) на диску, щоб швидко знаходити ключі (наприклад, слова) та їхні списки документів. Інверсний індекс містить великі списки документів для кожного слова, а B-дерево дозволяє ефективно шукати це слово в індексі.

# Текстові індекси
MongoDB створює спеціальний текстовий індекс на полі (або полях) колекції, який допомагає швидко знаходити документи за словами чи фразами.
Пошук здійснюється оператором **$text** у запитах, який дозволяє вводити пошуковий рядок з ключовими словами.
Можливості пошуку:
* Пошук за одним або кількома словами
* Відхилення результатів за ключовим словом (виключення)
* Пошук з урахуванням ваги полів (різні поля можуть мати різний вплив на результат)

## Створення повнотекстових індексів у MongoDB
Припустимо, у вас є колекція **restaurants** з полями **name** та **description**. Щоб створити текстовий індекс на цих полях:

```javascript
db.restaurants.createIndex({ name: "text", description: "text" })
```

Це дозволить шукати текст у полях **name** та **description**.

# Приклади текстового пошуку

### Пошук за словом
Для пошуку всіх ресторанів, які містять слово "кухня" в індексованих полях:

```javascript
db.restaurants.find({ $text: { $search: "кухня" } })
```

### Пошук за кількома словами
Запит поверне документи, де зустрічаються "китайський" або "кухня":

```javascript
db.restaurants.find({ $text: { $search: "китайський кухня" } })
```

### Виключення слів
Пошук ресторанів, де є "китайський", але не "ресторан":


```javascript
db.restaurants.find({ $text: { $search: "китайський -ресторан" } })
```

### Якщо треба пошук точного вислову, можна написати:

```javascript
{ $text: { $search: "\"mongodb база\"" } }
```

### Важливі особливості:
* Пошук нечутливий до регістру.
* Можна використовувати логічні оператори (наприклад, мінус для виключення).
* MongoDB присвоює кожному документу оцінку релевантності (поле score), яка показує, наскільки документ підходить.

Щоб відсортувати результати за релевантністю:

```javascript
db.restaurants.find({ $text: { $search: "кухня" } }, { score: { $meta: "textScore" } }).sort({ score: { $meta: "textScore" } })
```

* **{ $text: { $search: "кухня" } }** — це умова пошуку, яка використовує оператор $text для повнотекстового пошуку словоформи "кухня" у проіндексованих текстових полях колекції restaurants.

* **{ score: { $meta: "textScore" } }** — це проекція, яка додає до кожного знайденого документа поле score. Це поле містить оцінку релевантності документа по відношенню до пошукового запиту, яку MongoDB автоматично рахує під час текстового пошуку.

* оператор **$meta** використовується для доступу до метаданих, які надаються результатами повнотекстового пошуку. Зокрема, він дозволяє отримати інформацію про релевантність результату пошуку, яка зберігається в полі, що містить значення індексу.

* **sort({ score: { $meta: "textScore" } })** — сортує результати за цим самим полем score у спадному порядку, тобто найбільш релевантні документи будуть на початку виводу.

### Пояснення та оптимізація пошуку
За допомогою методу **explain()** можна переглянути, скільки документів оглянуто, яку кількість документів повернуто. Це допомагає оптимізувати індекси:

```javascript
db.restaurants.find({ $text: { $search: "кухня" } }).explain("executionStats")
```

Також **$text** підтримує параметри:

* **$language** — встановити мову для аналізу тексту (стоп-слова, стемінг);

* **$caseSensitive** — для чутливості до регістру (за замовчуванням вимкнено).


В MongoDB при створенні текстового індексу можна призначати ваги (weights) окремим полям, щоб керувати їх впливом на релевантність пошуку. Це означає, що слово, знайдене у полі з більшою вагою, буде більш значимим для результатів пошуку, ніж у полі з меншою вагою.

Наприклад, якщо у вас є колекція з полями title (назва) та description (опис), ви можете дати полю title вагу 10, а description — вагу 5, щоб пошук більш орієнтувався на назву:

```javascript
db.collection.createIndex(
  { title: "text", description: "text" },
  { weights: { title: 10, description: 5 }, name: "TextIndex" }
)
```

Це означає, що якщо слово знайдене у title, документ отримає вищу оцінку релевантності, і він ймовірно буде вище у результатах пошуку.

Таким чином, ваги дозволяють налаштовувати пріоритетність полів у пошуковому індексі, щоб краще відображати важливість певних частин тексту з точки зору пошуку.

Ця можливість корисна, коли деякі поля мають більш значущу інформацію , і дозволяє контролювати порядок виводу результатів.
